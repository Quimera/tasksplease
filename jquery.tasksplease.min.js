(function($){function TasksPlease(item,conf){var self=this,sorteable=conf.sorteable,taskmanager;$.extend(self,{init:function(){self.setup()},create_task:function(text,position){if(position===undefined)position=-1;var task=$("<li/>");task.append($("<span />",{text:text,"class":"text"}));task.append('<a class="edit" href="#"><span>'+tp_i18n.edit_task+"</span></a>").append('<a class="remove" href="#"><span>'+tp_i18n.delete_task+"</span></a>");self.delete_event(task.find(".remove"),task);self.edit_event(task.find(".edit"), task);taskmanager.append(task);task.hide().fadeIn();return task},delete_task:function(index){element_to_delete=taskmanager.find("li")[index];if(element_to_delete!==undefined){$(element_to_delete).fadeOut(300,function(){$(this).remove()});var text_area_list=item.val().split("\n");text_area_list.splice(index,1);item.val(text_area_list.join("\n"))}},edit_task:function(index,new_value){element_to_edit=taskmanager.find("li")[index];if(element_to_edit!==undefined){var text_area_list=item.val().split("\n"); text_area_list[index]=new_value;item.val(text_area_list.join("\n"))}},make_sortable:function(){taskmanager.sortable({placeholder:"ui-state-highlight",stop:function(event,ui){var tasks_content=$.map(taskmanager.find(".text"),function(el){return $(el).text()});item.val(tasks_content.join("\n"))}})},setup:function(){var lines=[];taskmanager=$('<ul class="tasksplease"/>');var value=item.val();if(value[0]!==undefined)lines=value.split("\n");$.each(lines,function(i,e){self.create_task(e,i)});self.container= $('<div class="tasksplease-container"/>');var add_new=$('<textarea type="text" name="task-description" class="task-description" rows="1" placeholder="'+tp_i18n.add_task+'"></textarea>');self.container.append(taskmanager).append(add_new).append('<input class="add_task" type="submit" value="'+tp_i18n.add+'"/>');item.after(self.container);self.add_new_event(self.container.find(".add_task"));item.hide();if(sorteable&&jQuery.ui&&"sortable"in jQuery.ui)self.make_sortable()},add_new_event:function(trigger){$(trigger).click(function(e){var description= $(this).siblings(".task-description");var value=description.val();if(value[0]!==undefined){var clean_text=value.replace(/(\r\n|\n|\r)/gm," ");self.create_task(clean_text);description_content=item.val()+"\n"+clean_text;if(item.val()[0]===undefined)description_content=clean_text;item.val(description_content);description.val("")}e.preventDefault()})},delete_event:function(trigger,element_to_delete){$(trigger).click(function(e){var index=$(element_to_delete).index();self.delete_task(index);e.preventDefault()})}, edit_event:function(trigger,element_to_edit){$(trigger).click(function(e){var index=element_to_edit.index();var edit=element_to_edit.find(".text");edit.replaceWith('<input type="text" value="'+edit.text()+'">');var input=element_to_edit.find("input");input.select();input.keypress(function(e){if(e.which==13){$(this).replaceWith($('<span class="text"/>').text(this.value));self.edit_task(index,this.value)}});e.preventDefault()})}});self.init()}$.fn.tasksplease=function(options){var el=this.data("tasksplease"); if(el)return el;var settings={"sorteable":true};if(options)$.extend(settings,options);return this.each(function(){el=new TasksPlease($(this),settings);$(this).data("tasksplease",el)})}})(jQuery);